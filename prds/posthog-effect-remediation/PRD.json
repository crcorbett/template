{
  "feature": "PostHog SDK Effect TS Remediation",
  "version": "1.0.0",
  "created": "2026-01-28",
  "updated": "2026-01-28",
  "verifyCommands": {
    "types": "npx tsc --noEmit",
    "test": "bun run test",
    "singleTest": "bun run test {file}",
    "note": "All tasks must pass types + tests. Run from packages/posthog/"
  },
  "tasks": [
    {
      "id": "P0-001",
      "category": "critical",
      "priority": "P0",
      "description": "Add withResource test helper using Effect.acquireUseRelease",
      "package": "@packages/posthog",
      "files": ["test/test.ts"],
      "steps": [
        "Open packages/posthog/test/test.ts",
        "Import Ref and Option from effect",
        "Add a withResource<A extends { id: number }> combinator that uses Effect.acquireUseRelease",
        "  - acquire: runs the create effect, returns the resource",
        "  - use: runs the test body with the resource",
        "  - release: calls cleanup(resource.id).pipe(Effect.catchAll(() => Effect.void))",
        "Export withResource from test.ts",
        "Verify it compiles with npx tsc --noEmit"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test"
      ],
      "passes": true,
      "notes": "withResource helper was already implemented at test/test.ts:175-182. Verified: 0 type errors, 224/224 tests passing."
    },
    {
      "id": "P0-002",
      "category": "critical",
      "priority": "P0",
      "description": "Fix Effect.ensuring eager evaluation bug in actions.test.ts",
      "package": "@packages/posthog",
      "files": ["test/actions.test.ts"],
      "steps": [
        "Open packages/posthog/test/actions.test.ts",
        "Replace all instances of the mutable let createdId + Effect.ensuring pattern",
        "Either use the new withResource helper from P0-001 or wrap the ensuring argument in Effect.suspend()",
        "Remove all `let createdId: number | undefined` declarations",
        "Remove all `createdId = created.id` and `createdId = undefined` assignments",
        "Ensure every CRUD test (create, update, get by id, filter, delete) still cleans up properly",
        "Run tests for this file specifically: bun run test test/actions.test.ts"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/actions.test.ts"
      ],
      "passes": true,
      "notes": "Already completed in prior session. No let createdId or Effect.ensuring patterns remain."
    },
    {
      "id": "P0-003",
      "category": "critical",
      "priority": "P0",
      "description": "Fix Effect.ensuring eager evaluation bug in annotations.test.ts",
      "package": "@packages/posthog",
      "files": ["test/annotations.test.ts"],
      "steps": [
        "Open packages/posthog/test/annotations.test.ts",
        "Apply the same pattern fix as P0-002 (withResource or Effect.suspend)",
        "Remove all mutable let createdId patterns",
        "Ensure all CRUD tests clean up properly"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/annotations.test.ts"
      ],
      "passes": true,
      "notes": "Already completed in prior session."
    },
    {
      "id": "P0-004",
      "category": "critical",
      "priority": "P0",
      "description": "Fix Effect.ensuring eager evaluation bug in cohorts.test.ts",
      "package": "@packages/posthog",
      "files": ["test/cohorts.test.ts"],
      "steps": [
        "Open packages/posthog/test/cohorts.test.ts",
        "Apply the same pattern fix as P0-002",
        "Remove all mutable let createdId patterns"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/cohorts.test.ts"
      ],
      "passes": true,
      "notes": "Already completed in prior session."
    },
    {
      "id": "P0-005",
      "category": "critical",
      "priority": "P0",
      "description": "Fix Effect.ensuring eager evaluation bug in dashboards.test.ts",
      "package": "@packages/posthog",
      "files": ["test/dashboards.test.ts"],
      "steps": [
        "Open packages/posthog/test/dashboards.test.ts",
        "Apply the same pattern fix as P0-002",
        "Remove all mutable let createdId patterns"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/dashboards.test.ts"
      ],
      "passes": true,
      "notes": "Already completed in prior session."
    },
    {
      "id": "P0-006",
      "category": "critical",
      "priority": "P0",
      "description": "Fix Effect.ensuring eager evaluation bug in experiments.test.ts",
      "package": "@packages/posthog",
      "files": ["test/experiments.test.ts"],
      "steps": [
        "Open packages/posthog/test/experiments.test.ts",
        "Apply the same pattern fix as P0-002",
        "Remove all mutable let createdId patterns"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/experiments.test.ts"
      ],
      "passes": true,
      "notes": "Already completed in prior session."
    },
    {
      "id": "P0-007",
      "category": "critical",
      "priority": "P0",
      "description": "Fix Effect.ensuring eager evaluation bug in feature-flags.test.ts",
      "package": "@packages/posthog",
      "files": ["test/feature-flags.test.ts"],
      "steps": [
        "Open packages/posthog/test/feature-flags.test.ts",
        "Apply the same pattern fix as P0-002",
        "Remove all mutable let createdId patterns"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/feature-flags.test.ts"
      ],
      "passes": true,
      "notes": "Already completed in prior session."
    },
    {
      "id": "P0-008",
      "category": "critical",
      "priority": "P0",
      "description": "Fix Effect.ensuring eager evaluation bug in insights.test.ts",
      "package": "@packages/posthog",
      "files": ["test/insights.test.ts"],
      "steps": [
        "Open packages/posthog/test/insights.test.ts",
        "Apply the same pattern fix as P0-002",
        "Remove all mutable let createdId patterns"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/insights.test.ts"
      ],
      "passes": true,
      "notes": "Already completed in prior session."
    },
    {
      "id": "P0-009",
      "category": "critical",
      "priority": "P0",
      "description": "Fix Effect.ensuring eager evaluation bug in surveys.test.ts",
      "package": "@packages/posthog",
      "files": ["test/surveys.test.ts"],
      "steps": [
        "Open packages/posthog/test/surveys.test.ts",
        "Apply the same pattern fix as P0-002",
        "Remove all mutable let createdId patterns"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/surveys.test.ts"
      ],
      "passes": true,
      "notes": "Already completed in prior session."
    },
    {
      "id": "P1-001",
      "category": "type-safety",
      "priority": "P1",
      "description": "Extract shared UserBasic schema to src/common.ts",
      "package": "@packages/posthog",
      "files": [
        "src/common.ts",
        "src/services/dashboards.ts",
        "src/services/feature-flags.ts",
        "src/services/insights.ts",
        "src/services/cohorts.ts",
        "src/services/surveys.ts",
        "src/services/actions.ts",
        "src/services/annotations.ts",
        "src/services/experiments.ts"
      ],
      "steps": [
        "Create packages/posthog/src/common.ts",
        "Move the UserBasic S.Class definition into common.ts",
        "Export UserBasic from common.ts",
        "In each of the 8 service files that define UserBasic:",
        "  - Remove the local UserBasic class definition",
        "  - Add import { UserBasic } from '../common.js'",
        "Verify no other duplicated schemas exist across services",
        "Update src/index.ts to export from common.ts if needed"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test"
      ],
      "passes": true,
      "notes": "Created src/common.ts with shared UserBasic schema. Replaced 8 duplicate definitions with imports. Re-exported UserBasic from each service file and from src/index.ts. 0 type errors, 224/224 tests passing."
    },
    {
      "id": "P1-002",
      "category": "type-safety",
      "priority": "P1",
      "description": "Replace S.Unknown in dashboards.ts with proper schemas",
      "package": "@packages/posthog",
      "files": ["src/services/dashboards.ts"],
      "steps": [
        "Open packages/posthog/src/services/dashboards.ts",
        "Reference schema.yaml for the Dashboard, DashboardTile types",
        "Replace S.Unknown fields: layouts, insight, text, filters, tags",
        "For tags: use S.Array(S.String) (PostHog tags are string arrays)",
        "For filters: define a DashboardFilter schema from the OpenAPI spec",
        "For layouts: define a Layout schema or use S.Record if truly dynamic",
        "For insight/text on DashboardTile: define appropriate union or struct schemas",
        "Ensure all existing tests still pass with the more specific schemas"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/dashboards.test.ts"
      ],
      "passes": true,
      "notes": "Replaced 5 S.Unknown usages with typed schemas: LayoutEntry (tile grid positioning), TileInsight (minimal insight ref), TileText (text tile content), DashboardFilter (date_from/date_to/properties), and S.Array(S.String) for tags. One deep S.Unknown remains in DashboardFilter.properties array items (17-member property filter union from OpenAPI). 0 type errors, 5/5 dashboard tests passing."
    },
    {
      "id": "P1-003",
      "category": "type-safety",
      "priority": "P1",
      "description": "Replace S.Unknown in feature-flags.ts with proper schemas",
      "package": "@packages/posthog",
      "files": ["src/services/feature-flags.ts"],
      "steps": [
        "Open packages/posthog/src/services/feature-flags.ts",
        "Reference schema.yaml for FeatureFlag filter types",
        "Replace S.Unknown fields: filters, experiment_set, surveys, features, rollback_conditions, tags",
        "For filters: define FeatureFlagFilters with groups, multivariate, etc.",
        "For tags: use S.Array(S.String)",
        "For experiment_set, surveys, features: reference the OpenAPI spec for proper types",
        "Ensure existing CRUD + filter tests pass"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/feature-flags.test.ts"
      ]
    },
    {
      "id": "P1-004",
      "category": "type-safety",
      "priority": "P1",
      "description": "Replace S.Unknown in insights.ts with proper schemas",
      "package": "@packages/posthog",
      "files": ["src/services/insights.ts"],
      "steps": [
        "Open packages/posthog/src/services/insights.ts",
        "Reference schema.yaml for Insight query types",
        "Replace S.Unknown fields: query, result, hasMore, columns, filters, tags",
        "For query: define InsightQuery union (TrendsQuery, FunnelsQuery, RetentionQuery, etc.)",
        "For tags: use S.Array(S.String)",
        "For result/columns: define appropriate schemas from the spec",
        "Ensure existing CRUD tests pass"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/insights.test.ts"
      ]
    },
    {
      "id": "P1-005",
      "category": "type-safety",
      "priority": "P1",
      "description": "Replace S.Unknown in cohorts.ts with proper schemas",
      "package": "@packages/posthog",
      "files": ["src/services/cohorts.ts"],
      "steps": [
        "Open packages/posthog/src/services/cohorts.ts",
        "Reference schema.yaml for Cohort filter types",
        "Replace S.Unknown fields: groups, filters, query",
        "For groups: define CohortGroup with properties, operator (AND/OR)",
        "For filters: define CohortFilter schema",
        "Ensure existing CRUD tests pass"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/cohorts.test.ts"
      ]
    },
    {
      "id": "P1-006",
      "category": "type-safety",
      "priority": "P1",
      "description": "Replace S.Unknown in surveys.ts with proper schemas",
      "package": "@packages/posthog",
      "files": ["src/services/surveys.ts"],
      "steps": [
        "Open packages/posthog/src/services/surveys.ts",
        "Reference schema.yaml for Survey question/appearance types",
        "Replace S.Unknown fields: questions (S.Array(S.Unknown)), appearance",
        "For questions: define SurveyQuestion schema with type (open, rating, choice, etc.), label, required, choices",
        "For appearance: define SurveyAppearance schema with color, position, etc.",
        "Ensure existing CRUD tests pass"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/surveys.test.ts"
      ]
    },
    {
      "id": "P1-007",
      "category": "type-safety",
      "priority": "P1",
      "description": "Replace S.Unknown in experiments.ts with proper schemas",
      "package": "@packages/posthog",
      "files": ["src/services/experiments.ts"],
      "steps": [
        "Open packages/posthog/src/services/experiments.ts",
        "Reference schema.yaml for Experiment parameter/metric types",
        "Replace S.Unknown fields: parameters, secondary_metrics, filters, metrics, metrics_secondary, stats_config",
        "For parameters: define ExperimentParameters schema",
        "For metrics: define ExperimentMetric schema",
        "Ensure existing CRUD tests pass"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/experiments.test.ts"
      ]
    },
    {
      "id": "P1-008",
      "category": "type-safety",
      "priority": "P1",
      "description": "Replace S.Unknown in actions.ts, events.ts, persons.ts with proper schemas",
      "package": "@packages/posthog",
      "files": [
        "src/services/actions.ts",
        "src/services/events.ts",
        "src/services/persons.ts"
      ],
      "steps": [
        "Open each file and reference schema.yaml for the relevant types",
        "actions.ts: replace properties (S.Array(S.Unknown)) and tags with proper schemas",
        "events.ts: replace properties, person, elements with proper schemas",
        "persons.ts: replace properties with S.Record({ key: S.String, value: S.Unknown }) or proper typed properties",
        "For tags across all services: use S.Array(S.String)",
        "Ensure all existing tests pass"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/actions.test.ts",
        "bun run test test/events.test.ts",
        "bun run test test/persons.test.ts"
      ]
    },
    {
      "id": "P1-009",
      "category": "type-safety",
      "priority": "P1",
      "description": "Convert parseJsonBody from async/await to Effect",
      "package": "@packages/posthog",
      "files": ["src/client/response-parser.ts"],
      "steps": [
        "Open packages/posthog/src/client/response-parser.ts",
        "Replace the async function parseJsonBody with an Effect-based implementation",
        "Use Effect.tryPromise or Effect.async for the ReadableStream consumption",
        "Replace try { JSON.parse(text) } catch with Effect.try({ try: () => JSON.parse(text), catch: ... })",
        "Remove the while(true) loop -- use Stream.fromReadableStream if appropriate, or Effect.loop",
        "Update the caller (makeResponseParser) to use Effect.flatMap instead of calling the async function",
        "Ensure parseResponse still works correctly for all response types (success, error, empty body)",
        "Run response-parser tests to verify"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/client/response-parser.test.ts",
        "bun run test"
      ]
    },
    {
      "id": "P1-010",
      "category": "type-safety",
      "priority": "P1",
      "description": "Replace synchronous throw with Effect.fail in request-builder.ts",
      "package": "@packages/posthog",
      "files": ["src/client/request-builder.ts"],
      "steps": [
        "Open packages/posthog/src/client/request-builder.ts",
        "Find line 129: throw new Error('No HTTP trait found on input schema')",
        "Create a new TaggedError: class MissingHttpTraitError extends S.TaggedError(...)('MissingHttpTraitError', { message: S.String }) {}",
        "Add MissingHttpTraitError to src/errors.ts or keep it local if internal-only",
        "Replace the throw with returning an Effect.fail(new MissingHttpTraitError(...))",
        "Update makeRequestBuilder to return an Effect instead of throwing synchronously",
        "Update callers (api.ts) to handle the new Error channel",
        "Also remove the ! non-null assertion on line 157: getHttpQuery(prop)! -- use Option.getOrThrowWith or similar"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/client/request-builder.test.ts",
        "bun run test"
      ]
    },
    {
      "id": "P1-011",
      "category": "type-safety",
      "priority": "P1",
      "description": "Remove type assertions from response-parser.test.ts",
      "package": "@packages/posthog",
      "files": ["test/client/response-parser.test.ts"],
      "steps": [
        "Open packages/posthog/test/client/response-parser.test.ts",
        "There are 26 instances of (error as PostHogError).code / .message / .details",
        "Create a typed assertion helper: const expectPostHogError = (error: unknown): PostHogError => { expect(error).toBeInstanceOf(PostHogError); return error as PostHogError; }",
        "Or better: use Effect's typed error channels -- if the test uses Effect.flip, the error type should already be known",
        "Replace every (error as PostHogError) with the typed helper or proper Effect error typing",
        "Ensure zero as casts remain in this file",
        "Verify all 542-line test file still passes"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/client/response-parser.test.ts"
      ]
    },
    {
      "id": "P1-012",
      "category": "type-safety",
      "priority": "P1",
      "description": "Remove type assertions from traits.test.ts",
      "package": "@packages/posthog",
      "files": ["test/traits.test.ts"],
      "steps": [
        "Open packages/posthog/test/traits.test.ts",
        "There are 12 type assertions: as T.HttpTrait, as AST.TypeLiteral, as unknown as",
        "For AST.TypeLiteral casts: create a typed helper getPropertySignatures(schema) that narrows the AST type",
        "For annotation casts: use the existing getAnnotation/hasAnnotation helpers from traits.ts",
        "For the as unknown as double-cast on line 122-124: refactor to use the proper annotation API",
        "Remove all as casts from test code",
        "Also remove 7 non-null assertions (props[0]!) -- use Array.headNonEmpty or expect + guard"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/traits.test.ts"
      ]
    },
    {
      "id": "P1-013",
      "category": "type-safety",
      "priority": "P1",
      "description": "Remove type assertions from request-builder.test.ts and credentials.test.ts",
      "package": "@packages/posthog",
      "files": [
        "test/client/request-builder.test.ts",
        "test/credentials.test.ts"
      ],
      "steps": [
        "request-builder.test.ts: 3 instances of JSON.parse(request.body as string)",
        "  - request.body is string | undefined; guard with expect(request.body).toBeDefined() then use request.body!",
        "  - Or better: use a typed helper that asserts and returns string",
        "credentials.test.ts: 1 instance of (error as Error).message",
        "  - Use expect(error).toBeInstanceOf(Error) then access .message",
        "  - Or use Effect's typed error channel from the Config failure"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/client/request-builder.test.ts",
        "bun run test test/credentials.test.ts"
      ]
    },
    {
      "id": "P2-001",
      "category": "effect-idiom",
      "priority": "P2",
      "description": "Replace plain Error with TaggedError in credentials.ts",
      "package": "@packages/posthog",
      "files": ["src/credentials.ts", "src/errors.ts"],
      "steps": [
        "Open packages/posthog/src/errors.ts",
        "Add: export class MissingCredentialsError extends S.TaggedError<MissingCredentialsError>()('MissingCredentialsError', { message: S.String }) {}",
        "Open packages/posthog/src/credentials.ts",
        "Replace line 37: new Error('POSTHOG_API_KEY environment variable is not set')",
        "With: new MissingCredentialsError({ message: 'POSTHOG_API_KEY environment variable is not set' })",
        "Update the fromEnv() Layer type signature to include MissingCredentialsError",
        "Update any tests that catch this error"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/credentials.test.ts",
        "bun run test"
      ]
    },
    {
      "id": "P2-002",
      "category": "effect-idiom",
      "priority": "P2",
      "description": "Replace instanceof checks with _tag discriminants in retry.ts",
      "package": "@packages/posthog",
      "files": ["src/retry.ts"],
      "steps": [
        "Open packages/posthog/src/retry.ts",
        "Replace isRateLimitError (lines 17-22):",
        "  - Remove: error instanceof RateLimitError",
        "  - Keep: _tag check only: (typeof error === 'object' && error !== null && '_tag' in error && error._tag === 'RateLimitError')",
        "  - Or simpler: use a helper hasTag('RateLimitError')",
        "Apply same change to isServerError (lines 24-29)",
        "Create a generic hasTag helper: const hasTag = (tag: string) => (error: unknown): boolean => ...",
        "Ensure retry policies still work correctly"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test"
      ]
    },
    {
      "id": "P2-003",
      "category": "effect-idiom",
      "priority": "P2",
      "description": "Add error category system matching distilled-aws",
      "package": "@packages/posthog",
      "files": ["src/errors.ts", "src/retry.ts"],
      "steps": [
        "Open packages/posthog/src/errors.ts",
        "Add a category symbol: const categorySymbol = Symbol.for('@posthog/error/categories')",
        "Add category types: type ErrorCategory = 'throttling' | 'server' | 'auth' | 'validation' | 'notFound'",
        "Add withCategory decorator function that stamps the category onto the error class prototype",
        "Add predicate functions: isThrottlingError, isServerError, isAuthError, isTransientError",
        "Decorate existing errors: RateLimitError with 'throttling', ServerError with 'server', AuthenticationError with 'auth', etc.",
        "Update src/retry.ts to use isThrottlingError and isTransientError predicates from the category system",
        "Remove the old instanceof-based checks",
        "Export category predicates from errors.ts"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test"
      ]
    },
    {
      "id": "P2-004",
      "category": "effect-idiom",
      "priority": "P2",
      "description": "Convert if/else chains to Match in traits.ts",
      "package": "@packages/posthog",
      "files": ["src/traits.ts"],
      "steps": [
        "Open packages/posthog/src/traits.ts",
        "Import Match from effect",
        "Lines 264-285 (hasAnnotation): convert if/else chain on ast._tag to Match.value(ast._tag).pipe(...)",
        "Lines 290-321 (getAnnotationUnwrap): convert if/else chain on ast._tag to Match pattern",
        "Lines 117-133 (JsonName): convert if/else if/else on schema type to Match pattern",
        "Use Match.when for each branch, Match.orElse for the default",
        "Preserve exact behaviour -- these are performance-sensitive functions"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/traits.test.ts",
        "bun run test"
      ]
    },
    {
      "id": "P2-005",
      "category": "effect-idiom",
      "priority": "P2",
      "description": "Replace console.log with Effect.log in saas-analytics-setup.test.ts",
      "package": "@packages/posthog",
      "files": ["test/saas-analytics-setup.test.ts"],
      "steps": [
        "Open packages/posthog/test/saas-analytics-setup.test.ts",
        "Find all console.log calls (lines 1286-1295)",
        "Replace with yield* Effect.log(...) since we are inside an Effect.gen block",
        "Use Effect.logInfo for informational output",
        "Use Effect.annotateLogs for structured resource count data",
        "Ensure the test output is still human-readable"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test test/saas-analytics-setup.test.ts"
      ]
    },
    {
      "id": "P2-006",
      "category": "effect-idiom",
      "priority": "P2",
      "description": "Replace console.log with Effect.log in provision-analytics.ts",
      "package": "@packages/posthog",
      "files": ["scripts/provision-analytics.ts"],
      "steps": [
        "Open packages/posthog/scripts/provision-analytics.ts",
        "Replace all ~40 console.log calls with yield* Effect.log(...)",
        "Replace console.error on line 1065 with Effect.logError",
        "Replace process.exit(1) with Effect.die or proper error handling",
        "Remove all 25 non-null assertions (.name!, .content!) by using Option.getOrThrowWith or adding guards",
        "Replace the 7 `as { id: number; name: string }[]` casts with properly typed empty arrays: Array<{ id: number; name: string }>()",
        "Replace Date.now() on line 37 with Effect.clockWith or accept it as non-effectful"
      ],
      "verify": [
        "npx tsc --noEmit"
      ]
    },
    {
      "id": "P2-007",
      "category": "effect-idiom",
      "priority": "P2",
      "description": "Deduplicate .env config resolution in test.ts",
      "package": "@packages/posthog",
      "files": ["test/test.ts"],
      "steps": [
        "Open packages/posthog/test/test.ts",
        "The fs.exists('../../.env') + ConfigProvider.orElse pattern is duplicated 3 times (lines 101-113, 135-147)",
        "Extract into a shared function: const resolveConfigProvider = (fs: FileSystem) => Effect.gen(function* () { ... })",
        "Replace all 3 occurrences with the shared function",
        "Also consider replacing the process.env.DEBUG ternary on line 195 with Config.string('DEBUG').pipe(Config.withDefault('false'))"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test"
      ]
    },
    {
      "id": "P2-008",
      "category": "effect-idiom",
      "priority": "P2",
      "description": "Add pagination support with Stream.unfoldEffect",
      "package": "@packages/posthog",
      "files": ["src/client/api.ts"],
      "steps": [
        "Open packages/posthog/src/client/api.ts",
        "Import Stream and Option from effect",
        "Add a makePaginated function that wraps make() with pagination:",
        "  - .pages(input): returns a Stream of pages using Stream.unfoldEffect",
        "  - .items(input): returns a Stream of individual results using Stream.mapConcat",
        "The unfold function should check result.next to determine if more pages exist",
        "Calculate the next offset from the current offset + results.length",
        "Export makePaginated from the client",
        "Update at least one service (e.g. dashboards) to use makePaginated for listDashboards",
        "Add a test that verifies pagination streaming works"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test"
      ]
    },
    {
      "id": "P3-001",
      "category": "polish",
      "priority": "P3",
      "description": "Add /*@__PURE__*/ annotations to API.make() calls for tree-shaking",
      "package": "@packages/posthog",
      "files": [
        "src/services/dashboards.ts",
        "src/services/feature-flags.ts",
        "src/services/insights.ts",
        "src/services/cohorts.ts",
        "src/services/events.ts",
        "src/services/persons.ts",
        "src/services/surveys.ts",
        "src/services/actions.ts",
        "src/services/annotations.ts",
        "src/services/experiments.ts",
        "src/services/me.ts"
      ],
      "steps": [
        "In each service file, find the makeClient() call for each exported operation",
        "Prepend /*@__PURE__*/ /*#__PURE__*/ before each makeClient() call",
        "Example: export const listDashboards = /*@__PURE__*/ /*#__PURE__*/ makeClient(ListDashboards)",
        "This tells bundlers the call has no side effects and can be tree-shaken"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test"
      ]
    },
    {
      "id": "P3-002",
      "category": "polish",
      "priority": "P3",
      "description": "Convert raw interfaces to Schema for client types",
      "package": "@packages/posthog",
      "files": [
        "src/client/request.ts",
        "src/client/response.ts",
        "src/client/operation.ts",
        "src/traits.ts"
      ],
      "steps": [
        "src/client/request.ts: Convert interface Request to S.Class or S.Struct + type alias",
        "src/client/response.ts: Convert interface Response to S.Class or S.Struct + type alias",
        "src/client/operation.ts: Convert interface Operation to S.Class or S.Struct + type alias",
        "src/traits.ts: Convert HttpTrait, PostHogServiceTrait, PaginatedTrait to Schema definitions",
        "Derive types from schemas using typeof Schema.Type",
        "Update all imports/usage sites"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test"
      ]
    },
    {
      "id": "P3-003",
      "category": "polish",
      "priority": "P3",
      "description": "Replace mutable let variables with Ref or pipeline composition in source files",
      "package": "@packages/posthog",
      "files": [
        "src/client/response-parser.ts",
        "src/client/api.ts",
        "src/client/request-builder.ts",
        "src/traits.ts"
      ],
      "steps": [
        "src/client/response-parser.ts line 33: let offset -- replace with functional accumulation in the stream processing (may be handled by P1-009)",
        "src/client/api.ts line 53: let httpRequest -- use pipe instead of reassignment",
        "src/client/request-builder.ts lines 87, 145-147, 207: let path, let payloadProp, let body -- use functional pipeline or Ref",
        "src/traits.ts line 360: let current -- use Array.reduce or pipe",
        "Each replacement must preserve exact behaviour"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test"
      ]
    },
    {
      "id": "P3-004",
      "category": "polish",
      "priority": "P3",
      "description": "Add explicit operation type signatures matching distilled-aws pattern",
      "package": "@packages/posthog",
      "files": [
        "src/services/dashboards.ts",
        "src/services/feature-flags.ts",
        "src/services/insights.ts",
        "src/services/cohorts.ts",
        "src/services/events.ts",
        "src/services/persons.ts",
        "src/services/surveys.ts",
        "src/services/actions.ts",
        "src/services/annotations.ts",
        "src/services/experiments.ts"
      ],
      "steps": [
        "For each exported operation function, add an explicit type annotation",
        "Include the full return type: Effect.Effect<OutputType, ErrorType | CommonErrors, Credentials | Endpoint | HttpClient>",
        "This makes the API surface self-documenting and matches distilled-aws",
        "Example: export const listDashboards: (input: ListDashboardsInput) => Effect.Effect<PaginatedDashboardList, PostHogError | CommonErrors, Credentials | Endpoint | HttpClient.HttpClient> = makeClient(ListDashboards)"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test"
      ]
    },
    {
      "id": "VERIFY-001",
      "category": "verification",
      "priority": "P0",
      "description": "Final verification: all tests pass, zero type errors, zero type assertions in source",
      "package": "@packages/posthog",
      "files": [],
      "steps": [
        "Run npx tsc --noEmit -- must be 0 errors",
        "Run bun run test -- must be 224+ tests passing",
        "Run grep -rn ' as ' src/ -- verify only acceptable traits.ts casts remain",
        "Run grep -rn ' as ' test/ -- verify zero casts remain",
        "Run grep -rn '\\!' src/ -- verify zero non-null assertions remain (except ! in regex/strings)",
        "Run grep -rn 'S\\.Unknown' src/ -- verify zero S.Unknown usage remains",
        "Run grep -rn 'instanceof' src/ -- verify zero instanceof checks remain",
        "Run grep -rn 'console\\.log' test/ scripts/ -- verify zero console.log in Effect contexts",
        "Run grep -rn 'throw ' src/ -- verify zero throw statements remain",
        "Verify PROGRESS.md is updated with all completed tasks"
      ],
      "verify": [
        "npx tsc --noEmit",
        "bun run test"
      ]
    }
  ]
}
