{
  "prd_id": 6,
  "title": "Admin Auth with Better Auth, Effect TS, and PostgreSQL/Drizzle",
  "completion_promise": "COMPLETE",
  "items": [
    {
      "category": "architectural",
      "description": "Add context git submodules for research repositories",
      "steps": [
        "Step 1: Create .context directory if it doesn't exist",
        "Step 2: Add git submodule for https://github.com/kitlangton/effect-better-auth-example",
        "Step 3: Add git submodule for https://github.com/better-auth/better-auth",
        "Step 4: Add git submodule for https://github.com/drizzle-team/drizzle-orm",
        "Step 5: Add git submodule for https://github.com/Effect-TS/effect",
        "Step 6: Add git submodule for https://github.com/overengineeringstudio/effect-utils",
        "Step 7: Configure all submodules with ignore=all in .gitmodules",
        "Step 8: Verify all submodules are cloned and accessible"
      ],
      "passes": false
    },
    {
      "category": "architectural",
      "description": "Research Effect + Better Auth integration patterns from context repos",
      "steps": [
        "Step 1: Study effect-better-auth-example for auth service patterns",
        "Step 2: Study better-auth repo for Drizzle adapter configuration",
        "Step 3: Study effect repo for Effect service patterns",
        "Step 4: Study effect-utils for reusable Effect utilities",
        "Step 5: Document findings in progress.txt with code examples"
      ],
      "passes": false
    },
    {
      "category": "architectural",
      "description": "Create Docker Compose setup for PostgreSQL",
      "steps": [
        "Step 1: Create docker-compose.yml at project root",
        "Step 2: Configure PostgreSQL service with health checks",
        "Step 3: Add persistent volume for database data",
        "Step 4: Configure environment variables for connection",
        "Step 5: Add .env.example with required variables",
        "Step 6: Update .gitignore for .env files",
        "Step 7: Verify PostgreSQL starts and accepts connections"
      ],
      "passes": false
    },
    {
      "category": "architectural",
      "description": "Create @packages/types package with auth and RBAC types",
      "steps": [
        "Step 1: Create packages/types directory with package.json",
        "Step 2: Configure TypeScript with tsconfig.json extending base",
        "Step 3: Create src/index.ts with initial exports",
        "Step 4: Add User, Session, AuthProvider types",
        "Step 5: Add Role type (admin, editor, viewer)",
        "Step 6: Add Permission type with granular permissions (users:read, users:write, posts:read, posts:write, posts:delete)",
        "Step 7: Add UserRole and RolePermission junction types",
        "Step 8: Update root workspace to include new package",
        "Step 9: Verify package builds and exports correctly"
      ],
      "passes": false
    },
    {
      "category": "architectural",
      "description": "Create @packages/database package with Drizzle + PostgreSQL + RBAC schema",
      "steps": [
        "Step 1: Create packages/database directory with package.json",
        "Step 2: Add drizzle-orm, drizzle-kit, and postgres dependencies",
        "Step 3: Configure drizzle.config.ts for PostgreSQL",
        "Step 4: Create src/schema/users.ts with users table",
        "Step 5: Create src/schema/sessions.ts with sessions table",
        "Step 6: Create src/schema/accounts.ts with OAuth accounts table",
        "Step 7: Create src/schema/roles.ts with roles table (admin, editor, viewer)",
        "Step 8: Create src/schema/permissions.ts with permissions table",
        "Step 9: Create src/schema/user-roles.ts junction table",
        "Step 10: Create src/schema/role-permissions.ts junction table",
        "Step 11: Create src/client.ts with database connection using Effect",
        "Step 12: Create src/index.ts exporting schema and client",
        "Step 13: Add migration scripts to package.json",
        "Step 14: Create initial migration with all tables",
        "Step 15: Verify package builds and connects to PostgreSQL"
      ],
      "passes": false
    },
    {
      "category": "architectural",
      "description": "Configure Better Auth with Drizzle adapter and OAuth providers",
      "steps": [
        "Step 1: Add better-auth and @better-auth/drizzle dependencies to admin app",
        "Step 2: Create src/lib/auth.ts with Better Auth configuration",
        "Step 3: Configure Drizzle adapter pointing to @packages/database",
        "Step 4: Add Google OAuth provider configuration",
        "Step 5: Add Microsoft OAuth provider configuration",
        "Step 6: Create environment variables schema for OAuth credentials",
        "Step 7: Add callback URL configuration for both providers",
        "Step 8: Verify Better Auth initialises without errors"
      ],
      "passes": false
    },
    {
      "category": "architectural",
      "description": "Set up Vitest in monorepo with workspace configuration",
      "steps": [
        "Step 1: Add vitest as dev dependency to root package.json",
        "Step 2: Create vitest.config.ts at project root",
        "Step 3: Configure workspace patterns for apps and packages",
        "Step 4: Add test script to root package.json",
        "Step 5: Add vitest.config.ts to @packages/database",
        "Step 6: Add vitest.config.ts to @packages/types",
        "Step 7: Add vitest.config.ts to apps/admin",
        "Step 8: Verify vitest runs across all workspaces"
      ],
      "passes": false
    },
    {
      "category": "architectural",
      "description": "Integrate Effect TS into admin app API layer",
      "steps": [
        "Step 1: Add effect dependency to admin app",
        "Step 2: Create src/lib/effect/runtime.ts with Effect runtime configuration",
        "Step 3: Create src/lib/effect/services/auth.ts with auth service layer",
        "Step 4: Create src/lib/effect/services/database.ts wrapping Drizzle",
        "Step 5: Create src/lib/effect/services/permissions.ts for RBAC checks",
        "Step 6: Create src/utils/effect-handler.ts for TanStack Start integration",
        "Step 7: Verify Effect services can be used in API routes"
      ],
      "passes": false
    },
    {
      "category": "functional",
      "description": "Create auth API routes with Effect handlers",
      "steps": [
        "Step 1: Create src/routes/api/auth/[...all].ts for Better Auth routes",
        "Step 2: Create src/routes/api/auth/session.ts for session info",
        "Step 3: Wrap auth handlers with Effect for error handling",
        "Step 4: Add proper CORS and security headers",
        "Step 5: Verify OAuth callback routes work correctly"
      ],
      "passes": false
    },
    {
      "category": "functional",
      "description": "Create permission-aware auth middleware",
      "steps": [
        "Step 1: Create src/utils/auth-middleware.ts using TanStack middleware pattern",
        "Step 2: Integrate Better Auth session verification",
        "Step 3: Add role checking logic (admin, editor, viewer)",
        "Step 4: Add granular permission checking (users:read, posts:write, etc.)",
        "Step 5: Create requireAuth middleware that redirects unauthenticated users",
        "Step 6: Create requireRole middleware for role-based access",
        "Step 7: Create requirePermission middleware for granular access",
        "Step 8: Wrap middleware with Effect for consistent error handling",
        "Step 9: Verify middleware can be composed with existing logging middleware"
      ],
      "passes": false
    },
    {
      "category": "functional",
      "description": "Create login/logout UI components",
      "steps": [
        "Step 1: Create src/components/auth/login-button.tsx with OAuth options",
        "Step 2: Create src/components/auth/logout-button.tsx",
        "Step 3: Create src/components/auth/user-menu.tsx showing current user and role",
        "Step 4: Create src/routes/login.tsx login page with Google and Microsoft buttons",
        "Step 5: Add auth state to root layout showing user menu when logged in",
        "Step 6: Style components using existing UI patterns from @packages/ui",
        "Step 7: Verify login/logout flow works end-to-end"
      ],
      "passes": false
    },
    {
      "category": "functional",
      "description": "Protect admin routes with role and permission checks",
      "steps": [
        "Step 1: Apply requireAuth middleware to existing admin routes (posts, users)",
        "Step 2: Create authenticated layout wrapper",
        "Step 3: Add redirect to login for unauthenticated access",
        "Step 4: Preserve original URL for post-login redirect",
        "Step 5: Apply role-based restrictions to sensitive routes",
        "Step 6: Verify protected routes require authentication and proper permissions"
      ],
      "passes": false
    },
    {
      "category": "functional",
      "description": "Create user management UI for admins",
      "steps": [
        "Step 1: Create src/routes/admin/users.tsx user list page",
        "Step 2: Create src/routes/admin/users.$userId.tsx user detail page",
        "Step 3: Add role assignment functionality (admin only)",
        "Step 4: Add permission management for roles",
        "Step 5: Create API routes for user management operations",
        "Step 6: Apply admin-only middleware to user management routes",
        "Step 7: Verify only admins can access user management"
      ],
      "passes": false
    },
    {
      "category": "testing",
      "description": "Add tests for auth flow and RBAC",
      "steps": [
        "Step 1: Set up test database configuration",
        "Step 2: Create tests for Better Auth configuration",
        "Step 3: Create tests for Effect auth service",
        "Step 4: Create tests for auth middleware (requireAuth)",
        "Step 5: Create tests for role middleware (requireRole)",
        "Step 6: Create tests for permission middleware (requirePermission)",
        "Step 7: Create integration tests for OAuth flow (mocked providers)",
        "Step 8: Create tests for role assignment logic",
        "Step 9: Verify all tests pass"
      ],
      "passes": false
    },
    {
      "category": "testing",
      "description": "Add tests for database package",
      "steps": [
        "Step 1: Create tests for Drizzle schema validation",
        "Step 2: Create tests for database client connection",
        "Step 3: Create tests for Effect-wrapped database operations",
        "Step 4: Create tests for RBAC queries (get user roles, check permissions)",
        "Step 5: Add migration test to verify schema applies correctly",
        "Step 6: Verify all tests pass"
      ],
      "passes": false
    }
  ]
}
